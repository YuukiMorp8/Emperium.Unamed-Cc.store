<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Aguardando Pagamento</title>
<style>
    html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        font-family: Arial, sans-serif;
        background: #111;
        color: #fff;
        box-sizing: border-box;
    }

    body {
        display: flex;
        justify-content: center;
        align-items: stretch; /* ocupa toda a altura */
    }

    .container {
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #1a1a1a, #222222);
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        padding: 40px 15px;
        box-sizing: border-box;
        overflow-y: auto;
    }

    h2 {
        font-size: 42px;
        margin-bottom: 40px;
        text-align: center;
        color: #b9894d;
    }

    .embed {
        background: #2a2a2a;
        border-left: 5px solid #997733;
        border-radius: 14px;
        padding: 26px;
        margin: 20px 0;
        width: 100%;
        box-sizing: border-box;
        text-align: left;
    }

    .embed h3 {
        margin-top: 0;
        font-size: 28px;
        color: #ccaa77;
    }

    .embed p {
        margin: 14px 0;
        font-size: 21px;
    }

    button {
        margin-top: 20px;
        width: 100%;
        padding: 24px;
        border-radius: 16px;
        border: none;
        font-size: 23px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.3s;
    }

    button:hover {
        transform: scale(1.03);
    }

    button:not(.confirm-btn) {
        background: #997733;
        color: #fff;
    }

    button:not(.confirm-btn):hover {
        background: #aa8844;
    }

    .confirm-btn {
        background: #228844;
        color: #fff;
        margin-top: 32px;
    }

    .confirm-btn:hover {
        background: #33aa66;
    }

    .hidden {
        display: none;
    }

    .buttons-confirmed button {
        width: 48%;
        margin: 5px 1%;
        display: inline-block;
    }

    /* Responsivo para celular */
    @media (max-width: 768px) {
        .container {
            padding: 30px 10px;
        }
        h2 {
            font-size: 36px;
        }
        .embed h3 {
            font-size: 26px;
        }
        .embed p {
            font-size: 19px;
        }
        button {
            font-size: 22px;
            padding: 20px;
        }
    }
</style>
</head>
<body>
<div class="container">
    <h2>üí∞ Aguardando Pagamento</h2>

    <!-- Embed 1 -->
    <div class="embed">
        <h3>üí∞ Aguardando Pagamento</h3>
        <p>Estamos aguardando a confirma√ß√£o do seu pagamento!</p>
        <p>Tempo estimado: 10 segundos a 2 minutos</p>
    </div>

    <!-- Embed 2 -->
    <div class="embed">
        <h3>‚åõ Verifica√ß√£o</h3>
        <p id="mensagem">Verificando automaticamente...</p>
        <p id="contador">Pr√≥xima tentativa em: 10s</p>
        <button id="verificar">Verificar Pagamento</button>
    </div>

    <!-- Bot√µes finais (inicialmente escondidos) -->
    <div id="botoes-confirmados" class="buttons-confirmed hidden">
        <form action="{{ url_for('dashboard') }}" method="get" style="display:inline;">
            <button type="submit">üè† Voltar √† Dashboard</button>
        </form>
        <form action="{{ url_for('adicionar_saldo_user') }}" method="get" style="display:inline;">
            <button type="submit">üí≥ Adicionar saldo novamente</button>
        </form>
    </div>
</div>

<script>
let txid = "{{ txid }}";
const botao = document.getElementById("verificar");
const contadorEl = document.getElementById("contador");
const mensagemEl = document.getElementById("mensagem");
const botoesConfirmados = document.getElementById("botoes-confirmados");

const TENTATIVAS = 6;
const INTERVALO = 10;
let tentativasRestantes = TENTATIVAS;
let contador = INTERVALO;

// Fun√ß√£o de verifica√ß√£o
async function verificarPagamento() {
    botao.disabled = true;
    mensagemEl.innerText = "Verificando...";
    try {
        let resp = await fetch(`/verificar_pagamento_ajax/${txid}`);
        let data = await resp.json();
        console.log("DEBUG resposta:", data);

        if(data.status && data.status.toLowerCase() === "concluida"){
            mensagemEl.innerText = `‚úÖ Pagamento confirmado! Saldo adicionado: R$ ${parseFloat(data.valor).toFixed(2)}`;
            contadorEl.style.display = 'none';
            botao.style.display = 'none';
            botoesConfirmados.classList.remove('hidden');
        } else if(data.status) {
            mensagemEl.innerText = "‚åõ Pagamento ainda n√£o confirmado.";
        } else {
            mensagemEl.innerText = "‚ùå Erro: resposta inv√°lida do servidor.";
        }
    } catch(e){
        console.error(e);
        mensagemEl.innerText = "‚ùå Erro ao verificar pagamento.";
    }
}

// Contador autom√°tico
function iniciarContador() {
    contadorEl.style.display = 'block';
    contador = INTERVALO;
    let timer = setInterval(() => {
        contador--;
        contadorEl.innerText = `Pr√≥xima tentativa em: ${contador}s`;
        if(contador <= 0){
            clearInterval(timer);
            if(tentativasRestantes > 0){
                verificarPagamento();
                tentativasRestantes--;
                if(tentativasRestantes > 0){
                    iniciarContador();
                } else {
                    botao.disabled = false;
                    contadorEl.innerText = `Voc√™ pode tentar novamente clicando no bot√£o.`;
                }
            }
        }
    }, 1000);
}

// Inicia verifica√ß√µes autom√°ticas
verificarPagamento();
tentativasRestantes--;
iniciarContador();

// Bot√£o manual
botao.addEventListener("click", () => {
    tentativasRestantes = TENTATIVAS;
    verificarPagamento();
    tentativasRestantes--;
    iniciarContador();
});
</script>
</body>
</html>
