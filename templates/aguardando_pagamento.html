<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Aguardando Pagamento - Emperium</title>
<style>
    html, body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        font-family: "Segoe UI", Arial, sans-serif;
        background: #0b0b0b;
        color: #fff;
        box-sizing: border-box;
    }

    body {
        display: flex;
        justify-content: center;
        align-items: stretch;
    }

    .container {
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, #101010, #181818);
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        padding: 50px 20px;
        box-sizing: border-box;
        overflow-y: auto;
    }

    h2 {
        font-size: 44px;
        margin-bottom: 35px;
        text-align: center;
        color: #c79b4b;
        text-shadow: 0 0 10px rgba(199, 155, 75, 0.4);
    }

    /* EMBED */
    .embed {
        background: rgba(20, 20, 20, 0.9);
        border-left: 6px solid #c79b4b;
        border-radius: 18px;
        padding: 30px;
        margin: 25px 0;
        width: 100%;
        max-width: 520px;
        box-sizing: border-box;
        box-shadow: 0 0 20px rgba(0,0,0,0.6);
        text-align: left;
    }

    .embed h3 {
        margin-top: 0;
        font-size: 26px;
        color: #e0b76a;
        margin-bottom: 10px;
    }

    .embed p {
        margin: 12px 0;
        font-size: 19px;
        color: #ccc;
    }

    /* BOT√ïES */
    button {
        margin-top: 20px;
        width: 100%;
        padding: 26px;
        border-radius: 16px;
        border: none;
        font-size: 23px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.3s;
        background: linear-gradient(90deg, #c79b4b, #b28633);
        color: #fff;
        box-shadow: 0 0 12px rgba(199, 155, 75, 0.3);
    }

    button:hover {
        transform: scale(1.04);
        background: linear-gradient(90deg, #e0b76a, #c79b4b);
        box-shadow: 0 0 16px rgba(199, 155, 75, 0.5);
    }

    .confirm-btn {
        background: linear-gradient(90deg, #1e8a44, #28a055);
        color: #fff;
        margin-top: 35px;
        box-shadow: 0 0 14px rgba(30,138,68,0.4);
    }

    .confirm-btn:hover {
        background: linear-gradient(90deg, #2cbc63, #34d171);
        box-shadow: 0 0 20px rgba(46,184,90,0.5);
    }

    .hidden {
        display: none;
    }

    .buttons-confirmed {
        display: flex;
        flex-direction: column;
        gap: 15px;
        width: 100%;
        max-width: 520px;
        margin-top: 20px;
    }

    /* RESPONSIVO */
    @media (max-width: 768px) {
        h2 {
            font-size: 36px;
        }
        .embed {
            padding: 24px;
        }
        .embed h3 {
            font-size: 24px;
        }
        .embed p {
            font-size: 18px;
        }
        button {
            font-size: 21px;
            padding: 22px;
        }
    }
</style>
</head>
<body>
<div class="container">
    <h2>üí∞ Aguardando Pagamento</h2>

    <!-- EMBED 1 -->
    <div class="embed">
        <h3>üí∞ Status</h3>
        <p>Estamos aguardando a confirma√ß√£o do seu pagamento.</p>
        <p>Tempo estimado: <strong>10 segundos a 2 minutos</strong>.</p>
    </div>

    <!-- EMBED 2 -->
    <div class="embed">
        <h3>‚åõ Verifica√ß√£o</h3>
        <p id="mensagem">Verificando automaticamente...</p>
        <p id="contador">Pr√≥xima tentativa em: 10s</p>
        <button id="verificar">üîÑ Verificar Pagamento</button>
    </div>

    <!-- BOT√ïES FINAIS -->
    <div id="botoes-confirmados" class="buttons-confirmed hidden">
        <form action="{{ url_for('dashboard') }}" method="get">
            <button type="submit">üè† Voltar √† Dashboard</button>
        </form>
        <form action="{{ url_for('adicionar_saldo_user') }}" method="get">
            <button type="submit" class="confirm-btn">üí≥ Adicionar Saldo Novamente</button>
        </form>
    </div>
</div>

<script>
let txid = "{{ txid }}";
const botao = document.getElementById("verificar");
const contadorEl = document.getElementById("contador");
const mensagemEl = document.getElementById("mensagem");
const botoesConfirmados = document.getElementById("botoes-confirmados");

const TENTATIVAS = 6;
const INTERVALO = 10;
let tentativasRestantes = TENTATIVAS;
let contador = INTERVALO;

// Fun√ß√£o de verifica√ß√£o
async function verificarPagamento() {
    botao.disabled = true;
    mensagemEl.innerText = "Verificando...";
    try {
        let resp = await fetch(`/verificar_pagamento_ajax/${txid}`);
        let data = await resp.json();

        if (data.status && data.status.toLowerCase() === "concluida") {
            mensagemEl.innerText = `‚úÖ Pagamento confirmado! Saldo adicionado: R$ ${parseFloat(data.valor).toFixed(2)}`;
            contadorEl.style.display = 'none';
            botao.style.display = 'none';
            botoesConfirmados.classList.remove('hidden');
        } else if (data.status) {
            mensagemEl.innerText = "‚åõ Pagamento ainda n√£o confirmado...";
        } else {
            mensagemEl.innerText = "‚ùå Erro: resposta inv√°lida do servidor.";
        }
    } catch (e) {
        console.error(e);
        mensagemEl.innerText = "‚ùå Erro ao verificar pagamento.";
    }
}

// Contador autom√°tico
function iniciarContador() {
    contadorEl.style.display = 'block';
    contador = INTERVALO;
    let timer = setInterval(() => {
        contador--;
        contadorEl.innerText = `Pr√≥xima tentativa em: ${contador}s`;
        if (contador <= 0) {
            clearInterval(timer);
            if (tentativasRestantes > 0) {
                verificarPagamento();
                tentativasRestantes--;
                if (tentativasRestantes > 0) {
                    iniciarContador();
                } else {
                    botao.disabled = false;
                    contadorEl.innerText = `Voc√™ pode tentar novamente clicando no bot√£o.`;
                }
            }
        }
    }, 1000);
}

// Inicia verifica√ß√µes autom√°ticas
verificarPagamento();
tentativasRestantes--;
iniciarContador();

// Bot√£o manual
botao.addEventListener("click", () => {
    tentativasRestantes = TENTATIVAS;
    verificarPagamento();
    tentativasRestantes--;
    iniciarContador();
});
</script>
</body>
</html>
