<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Aguardando Pagamento</title>
<style>
    body {
        background: #111;
        color: #fff;
        font-family: Arial, sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
    }
    .container {
        width: 420px;
        text-align: center;
    }
    .embed {
        background: #1e1e1e;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 15px;
        text-align: left;
    }
    .embed h3 {
        margin: 0 0 10px 0;
        color: #ff9900;
    }
    .embed p {
        margin: 5px 0;
    }
    button {
        margin-top: 10px;
        background: #ff9900;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
        color: #111;
        width: 100%;
    }
    button:disabled {
        background: #555;
        cursor: not-allowed;
    }
    .hidden {
        display: none;
    }
    .buttons-confirmed button {
        width: 48%;
        margin: 5px 1%;
        display: inline-block;
    }
</style>
</head>
<body>
<div class="container">
    <!-- Embed 1 -->
    <div class="embed">
        <h3>üí∞ Aguardando Pagamento</h3>
        <p>Estamos aguardando a confirma√ß√£o do seu pagamento!</p>
        <p>Tempo estimado: 10 segundos a 2 minutos</p>
    </div>

    <!-- Embed 2 -->
    <div class="embed">
        <h3>‚åõ Verifica√ß√£o</h3>
        <p id="mensagem">Verificando automaticamente...</p>
        <p id="contador">Pr√≥xima tentativa em: 10s</p>
        <button id="verificar">Verificar Pagamento</button>
    </div>

    <!-- Bot√µes finais (inicialmente escondidos) -->
    <div id="botoes-confirmados" class="buttons-confirmed hidden">
        <form action="{{ url_for('dashboard') }}" method="get" style="display:inline;">
            <button type="submit">üè† Voltar √† Dashboard</button>
        </form>
        <form action="{{ url_for('adicionar_saldo_user') }}" method="get" style="display:inline;">
            <button type="submit">üí≥ Adicionar saldo novamente</button>
        </form>
    </div>
</div>

<script>
let txid = "{{ txid }}";
const botao = document.getElementById("verificar");
const contadorEl = document.getElementById("contador");
const mensagemEl = document.getElementById("mensagem");
const botoesConfirmados = document.getElementById("botoes-confirmados");

const TENTATIVAS = 6;
const INTERVALO = 10;
let tentativasRestantes = TENTATIVAS;
let contador = INTERVALO;

// Fun√ß√£o de verifica√ß√£o
async function verificarPagamento() {
    botao.disabled = true;
    mensagemEl.innerText = "Verificando...";
    try {
        let resp = await fetch(`/verificar_pagamento_ajax/${txid}`);
        let data = await resp.json();
        console.log("DEBUG resposta:", data);

        if(data.status && data.status.toLowerCase() === "concluida"){
            mensagemEl.innerText = `‚úÖ Pagamento confirmado! Saldo adicionado: R$ ${parseFloat(data.valor).toFixed(2)}`;
            contadorEl.style.display = 'none';
            botao.style.display = 'none';
            botoesConfirmados.classList.remove('hidden');
        } else if(data.status) {
            mensagemEl.innerText = "‚åõ Pagamento ainda n√£o confirmado.";
        } else {
            mensagemEl.innerText = "‚ùå Erro: resposta inv√°lida do servidor.";
        }
    } catch(e){
        console.error(e);
        mensagemEl.innerText = "‚ùå Erro ao verificar pagamento.";
    }
}

// Contador autom√°tico
function iniciarContador() {
    contadorEl.style.display = 'block';
    contador = INTERVALO;
    let timer = setInterval(() => {
        contador--;
        contadorEl.innerText = `Pr√≥xima tentativa em: ${contador}s`;
        if(contador <= 0){
            clearInterval(timer);
            if(tentativasRestantes > 0){
                verificarPagamento();
                tentativasRestantes--;
                if(tentativasRestantes > 0){
                    iniciarContador();
                } else {
                    botao.disabled = false;
                    contadorEl.innerText = `Voc√™ pode tentar novamente clicando no bot√£o.`;
                }
            }
        }
    }, 1000);
}

// Inicia verifica√ß√µes autom√°ticas
verificarPagamento();
tentativasRestantes--;
iniciarContador();

// Bot√£o manual
botao.addEventListener("click", () => {
    tentativasRestantes = TENTATIVAS;
    verificarPagamento();
    tentativasRestantes--;
    iniciarContador();
});
</script>
</body>
</html>
